name: Cypress Tests

on: [push]

jobs:
  list-spec-files:

    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v2
      - id: set-matrix
        run: echo "::set-output name=matrix::$(ls e2e/specs/*.spec.js | jq -R -s -c 'split("\n")[:-1]')"

  build:

    runs-on: ubuntu-latest

    env:
      SUDO: 'sudo'
      BASH_ENV: $HOME/.bash_profile

    # container: circleci/python:3.7.11

    steps:
      # This Docker file changes sets USER to circleci instead of using the default user, so we need to update file permissions for this image to work on GH Actions.
      # See https://docs.github.com/actions/reference/virtual-environments-for-github-hosted-runners#docker-container-filesystem
      # - name: Setup file system permissions
      #   run: sudo chmod -R 777 $GITHUB_WORKSPACE /github /__w/_temp
      - name: Checkout Streamlit code
        uses: actions/checkout@v3
      - name: Set up Python 3.7.11
        uses: actions/setup-python@v4
        with:
            python-version: "3.7.11"
      - uses: ./.github/actions/update_submodules
      - uses: ./.github/actions/pre_make
      - uses: ./.github/actions/make_init
      - name: Run make develop
        run: |
          make develop
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Install Cypress dependencies
        run: |
          ${SUDO} apt-get install -y xvfb libgtk2.0-0 libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 jq curl
        shell: bash -l -v -e -u -o pipefail {0}
      # - name: Install Cypress dependencies
      #   uses: cypress-io/github-action@v2
      #   with:
      #     runTests: false
      # Revisit artifact saving
      # - name: Save Cypress artifacts
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: build
      #     if-no-files-found: error
      #     path: build
      - name: Init config
        run: |
          mkdir ~/.streamlit
          MAPBOX_TOKEN=$(curl -sS https://data.streamlit.io/tokens.json | jq -r '.["mapbox-localhost"]')
          echo '[mapbox]' >  ~/.streamlit/config.toml
          echo 'token = "'$MAPBOX_TOKEN'"' >> ~/.streamlit/config.toml
        shell: bash -l -v -e -u -o pipefail {0}
      - name: Init credentials
        run: |
          echo '[general]' >  ~/.streamlit/credentials.toml
          echo 'email = "test@streamlit.io"' >> ~/.streamlit/credentials.toml
        shell: bash -l -v -e -u -o pipefail {0}

  e2e_tests:

    runs-on: ubuntu-latest
    needs: [build, list-spec-files]

    strategy:
      fail-fast: false
      matrix:
        specs: ${{ fromJson(needs.list-spec-files.outputs.matrix) }}
  
    steps:
      - uses: actions/checkout@v2
      - name: Cypress Tests
        run: |
          cd frontend
          ../scripts/run_e2e_tests.py -a ${{ matrix.manifest }}
        shell: bash -l -v -e -u -o pipefail {0}

        # uses: cypress-io/github-action@v4
        # with:
        #   project: ./e2e/specs
        #   browser: chrome
        #   start: yarn start
        # env:
        #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        #   CI_TOTAL: ${{ matrix.ci_total }}
        #   CI_INDEX: ${{ matrix.ci_index }}
